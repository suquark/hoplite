#!/bin/bash

# This script can run commands on all nodes on the cluster: ./fornode <commands>

root_dir=$(dirname $(realpath -s $0))
my_address=$($root_dir/get_ip_address.sh)

# get cluster info
worker_pubips=$(ray get-worker-ips ~/ray_bootstrap_config.yaml)
slaves=()
for s in $worker_pubips; do slaves+=($(ssh -o StrictHostKeyChecking=no $s $root_dir/get_ip_address.sh)); done
all_nodes=($my_address ${slaves[@]})

for node in ${all_nodes[@]}; do
  echo "=> $node"
  ssh -o StrictHostKeyChecking=no $node PATH=$PATH:/home/ubuntu/anaconda3/bin:/home/ubuntu/anaconda3/condabin, $@ &
done
